<!DOCTYPE html>
<html>
 
<head>
	<meta charset="utf-8">
	<title>工作台</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<script type="text/html" id="tableOpeate" lay-filter="tableOpeate">
		<a class="layui-icon layui-icon-play"  id="run" lay-event="run" style="color: #16baaa"></a>
		<a class="layui-icon layui-icon-pause" id="pause" lay-event="pause"></a>
		<a class="layui-icon layui-icon-file" id="log" lay-event="log" style="color: #31bdec;"></a>
		<a class="layui-icon layui-icon-set-fill" id="setting" lay-event="setting"></a>
		<a class="layui-icon layui-icon-release" id="deploy" lay-event="deploy"></a>
		<a class="layui-icon layui-icon-loading-1 layui-anim layui-anim-rotate layui-anim-loop" id="loading" lay-event="loding"></a>
		<a class="layui-icon " id="healthz"></a>
	</script>
	<style type="text/css">
		.layui-icon {
			font-size: 20px;
		}	
	</style>
	<script type="text/html" id="toolbar">
		<div class="layui-inline ">
			<input type="text" id="search"  placeholder="搜索" autocomplete="off" class="layui-input" style="height:30px;width:160px">
		</div>
		<div class="layui-inline " style="height:30px;width:100px">
			<select id="orderState">
				<option value="0">所有状态</option>
				<option value="1">已支付</option>
				<option value="2">未支付</option>
				<option value="3">已结算</option>
			</select>
		</div>
		
		<button type="button" class="layui-btn layui-btn-sm" lay-event="add">创建工程</button>
	</script>
</head>

<body>
	<div class="pear-container">
		<div class="layui-row layui-col-space10">
			<div class="layui-col-md12">
				<div class="layui-row layui-col-space10">
					<div class="layui-col-md12">
						<div class="layui-card">
							<div class="layui-card-header">
								以太运维平台
							</div>
							<div class="layui-card-body">
								springboot+layui+mysql+redis+docker+jenkins+gitlab+harbor
							</div>
						</div>
					</div>

					<div class="layui-col-md12">
						<div class="layui-card">
							<div class="layui-card-header">
								<b>工程列表</b>
							</div>
							<div class="layui-card-body" style="padding-top: 15px; padding-bottom: 15px;">
								<table class="layui-hide" id="table-application" lay-filter="table-application"></table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		layui.use(['layer', 'table'], function () {
			var $ = layui.jquery,
				layer = layui.layer,
				table = layui.table

			var inst = table.render({
				elem: '#table-application',
				toolbar: "#toolbar",
				url: '/application',
				cols: [
					[{
						field: 'id',
						hide: true
					},
					{
						field: 'name',
						title: '名称'
					},
					{
						field: 'code',
						title: '代码'
					},
					{
						field: 'gmtCreate',
						title: '创建时间'
					},
					{
						field: 'healthz',
						title: '健康度'
					},
					{
						title: '操作',
						toolbar: '#tableOpeate',
						width: 200
					}
					]
				],
				page: true,
				parseData: function (res) {
					return {
						"code": 0,
						"msg": null,
						"data": res
					};
				}
			});

			table.on("toolbar(table-application)", function (obj) {
				if (obj.event === 'add') {
					layer.open({
						type: 1,
						title: '创建工程',
						maxHeight: 480,
						content: '<div id="pear-content" style="padding:16px"></div>',
						success: function (layero, index) {
							$('#pear-content').load('/view/build/application_add.html');
							$(layero).area = ['800px','auto'];
						}
					});
				}
			});
			table.on("tool(table-application)", function (obj) {
				var data = obj.data;
				if (obj.event === 'run') {
					layer.msg('运行: ' + data.id);
				} else if (obj.event === 'pause') {
					layer.msg('暂停: ' + data.id);
				} else if (obj.event === 'log') {
					layer.open({
						type: 1,
						title: '日志',
						area: ['800px', '600px'],
						content: '<div id="container-log" style="padding:16px"></div>',
						success: function (layero, index) {
							const eventSource = new EventSource('/devops/build/s2i/log/' + data.id);
							eventSource.onmessage = function(event) {
								$('#container-log').append(event.data + '<br>');
							};
							eventSource.onerror = function() {
								eventSource.close();
							};
						}
					});
				} else if (obj.event === 'setting') {

					layer.open({
						type: 1,
						title: '构建工程',
						area: ['800px', '600px'],
						btn: ['确认', '取消'],
						btn1: function (index, layero) {
							$.ajax({
								url: '/devops/build/s2i/ether/ether',
								data: layero.find('form').serialize(),
								type: 'POST'
							});
						},
						btn2: function (index, layero) {
							layer.close(index);
						},
						content: '<div id="container-buildInfo" style="padding:16px"></div>',
						success: function (layero, index) {
							$('#container-buildInfo').load('/view/build/build.html');
						}
						
					});
				} else if (obj.event === 'deploy') {
					layer.msg('部署: ' + data.id);
				} else if (obj.event === 'healthz') {
					layer.msg('healthz');
				}
			});
		});
	</script>
</body>

</html>